# üß™ Tests Clara - Agent IA Interactif

## üéØ Tests de Fonctionnalit√©s

### Test 1: V√©rification Cr√©dits ‚úÖ

**Sc√©nario:** L'utilisateur demande son solde de cr√©dits.

**Input:**
```
User: "Clara, combien de cr√©dits j'ai ?"
```

**Traitement Attendu:**
1. Clara identifie l'intention: `check_credits`
2. Clara appelle `ToolsService.checkCredits(ctx)`
3. R√©cup√®re le solde depuis `user_credits` table

**Output Attendu:**
```
Clara: "üí≥ Cr√©dits disponibles: 49

üìä Statistiques:
   ‚Ä¢ Total gagn√©: 100
   ‚Ä¢ Total d√©pens√©: 51

Tu es bien fourni en cr√©dits ! üéâ"
```

**Code de Test:**
```typescript
test('Check Credits Tool', async () => {
  const ctx = {
    userId: 'test-user-id',
    navigate: jest.fn(),
    userMetadata: { first_name: 'Test' }
  };

  const result = await ToolsService.checkCredits(ctx);

  expect(result.success).toBe(true);
  expect(result.data).toHaveProperty('balance');
  expect(result.data.balance).toBeGreaterThanOrEqual(0);
  expect(result.message).toContain('Cr√©dits disponibles');
});
```

---

### Test 2: Recherche Entreprise par SIRET ‚úÖ

**Sc√©nario:** L'utilisateur veut cr√©er un client professionnel.

**Input:**
```
User: "Cr√©e un client avec le SIRET 12345678900014"
```

**Traitement Attendu:**
1. Clara identifie: `create_client` avec type `company`
2. Clara appelle `ToolsService.searchCompanyBySiret('12345678900014')`
3. Appel API INSEE Sirene
4. R√©cup√®re donn√©es entreprise
5. Demande email/t√©l√©phone manquants

**Output Attendu:**
```
Clara: "‚úÖ Entreprise trouv√©e !

üìã TRANSPORT RAPIDE SARL
üìç 10 rue du Commerce, 75001 Paris
üî¢ SIRET: 123 456 789 00014
üî¢ SIREN: 123 456 789

As-tu l'email et le t√©l√©phone de contact ?"
```

**Code de Test:**
```typescript
test('Search Company by SIRET', async () => {
  const result = await ToolsService.searchCompanyBySiret('12345678900014');

  expect(result.success).toBe(true);
  expect(result.data).toHaveProperty('company_name');
  expect(result.data).toHaveProperty('siret');
  expect(result.data).toHaveProperty('address');
  expect(result.data.siret).toBe('12345678900014');
});
```

---

### Test 3: Cr√©ation Mission Compl√®te ‚úÖ

**Sc√©nario:** L'utilisateur cr√©e une mission de A √† Z.

**Conversation:**
```
User: "Clara, cr√©e une mission"

Clara: "Bonjour Mahdi ! üëã Parfait, cr√©ons une mission ensemble.
Quelle est la marque du v√©hicule ?"

User: "BMW"

Clara: "Et le mod√®le ?"

User: "S√©rie 3"

Clara: "D'accord ! BMW S√©rie 3. Adresse de d√©part ?"

User: "15 rue de Rivoli, Paris"

Clara: "Re√ßu ! Adresse d'arriv√©e ?"

User: "20 avenue des Champs-√âlys√©es, Paris"

Clara: "Parfait. Date et heure de d√©part ?"

User: "Demain 14h"

Clara: "Quel est le montant de cette mission (HT) ?"

User: "350‚Ç¨"

Clara: "üîç R√©capitulatif:

üöó V√©hicule: BMW S√©rie 3
üìç D√©part: 15 rue de Rivoli, Paris
üìç Arriv√©e: 20 avenue des Champs-√âlys√©es, Paris
üìÖ Date: 15 oct 2025 √† 14:00
üí∞ Prix: 350‚Ç¨ HT

üí≥ Cr√©dits n√©cessaires: 1
üí≥ Ton solde: 49 cr√©dits

Confirmes-tu la cr√©ation ?"

User: "Oui"

Clara: "‚úÖ Mission MISS-124 cr√©√©e avec succ√®s !

üéâ Revenu du mois: +350‚Ç¨
üé´ Cr√©dits restants: 48

üîó [Redirection vers /missions]"
```

**Code de Test:**
```typescript
test('Create Mission Complete Workflow', async () => {
  const ctx = {
    userId: 'test-user-id',
    navigate: jest.fn(),
    userMetadata: { first_name: 'Mahdi' }
  };

  const missionData = {
    vehicle_brand: 'BMW',
    vehicle_model: 'S√©rie 3',
    pickup_address: '15 rue de Rivoli, Paris',
    pickup_date: '2025-10-15T14:00:00',
    delivery_address: '20 avenue des Champs-√âlys√©es, Paris',
    price: 350
  };

  const result = await ToolsService.createMission(ctx, missionData);

  expect(result.success).toBe(true);
  expect(result.data).toHaveProperty('reference');
  expect(result.data.reference).toMatch(/MISS-\d{3}/);
  expect(result.data.status).toBe('pending');
  expect(result.redirect).toBe('/missions');
  expect(result.message).toContain('cr√©√©e avec succ√®s');
});
```

---

### Test 4: Suggestion Intelligente de Chauffeur ‚úÖ

**Sc√©nario:** Clara analyse tous les chauffeurs et recommande le meilleur.

**Input:**
```
User: "Quel chauffeur pour la mission MISS-124 ?"
```

**Traitement Attendu:**
1. Clara r√©cup√®re infos mission (v√©hicule, date, adresses)
2. Clara liste TOUS les chauffeurs depuis `contacts` table
3. Pour chaque chauffeur:
   - V√©rifie disponibilit√© (table `calendar_events`)
   - V√©rifie type de permis (light vs heavy_goods)
   - V√©rifie ville (proximit√© d√©part)
   - Calcule score (0-100)
4. Trie par score d√©croissant
5. Affiche top 3

**Output Attendu:**
```
Clara: "üéØ Suggestions de chauffeurs pour MISS-124:

1. ‚≠ê Jean Dupont (100/100)
   ‚úÖ Disponible le 15 oct
   ‚úÖ Permis l√©ger adapt√© (BMW S√©rie 3)
   ‚úÖ √Ä Paris (m√™me ville)
   ‚úÖ 5km du d√©part
   ‚≠ê Note: 4.8/5 (12 missions)

2. ü•à Marie Martin (70/100)
   ‚úÖ Disponible le 15 oct
   ‚úÖ Permis l√©ger adapt√©
   ‚ö†Ô∏è √Ä Lyon (490km du d√©part)
   ‚≠ê Note: 4.5/5 (8 missions)

3. ü•â Pierre Durand (60/100)
   ‚ùå Pas disponible le 15 oct (√©v√©nement au calendrier)
   ‚úÖ Permis l√©ger adapt√©
   ‚úÖ √Ä Paris
   ‚≠ê Note: 4.2/5 (5 missions)

üí° Je recommande Jean Dupont. Veux-tu lui assigner ?"
```

**Code de Test:**
```typescript
test('Suggest Driver with Scoring', async () => {
  const ctx = {
    userId: 'test-user-id',
    navigate: jest.fn(),
    userMetadata: { first_name: 'Mahdi' }
  };

  const missionData = {
    vehicle_type: 'light' as const,
    departure_city: 'Paris',
    departure_date: '2025-10-15'
  };

  const result = await ToolsService.suggestDriver(ctx, missionData);

  expect(result.success).toBe(true);
  expect(result.data).toBeInstanceOf(Array);
  expect(result.data.length).toBeGreaterThan(0);
  
  // V√©rifier que les chauffeurs sont tri√©s par score
  const scores = result.data.map((d: any) => d.score);
  const sortedScores = [...scores].sort((a, b) => b - a);
  expect(scores).toEqual(sortedScores);
  
  // V√©rifier que le meilleur chauffeur a le score le plus √©lev√©
  expect(result.data[0].score).toBe(Math.max(...scores));
});
```

---

### Test 5: Assignation Mission avec Revenus ‚úÖ

**Sc√©nario:** Assigner une mission et calculer la commission.

**Conversation:**
```
User: "Assigne la mission MISS-124 √† Jean Dupont"

Clara: "J'ai trouv√© Jean Dupont (chauffeur, Paris).
Combien gagne-t-il pour cette mission (HT) ?"

User: "200‚Ç¨"

Clara: "Et combien tu gagnes en commission (HT) ?"

User: "150‚Ç¨"

Clara: "üîç V√©rification:
   ‚Ä¢ Prestataire: 200‚Ç¨ HT
   ‚Ä¢ Commission: 150‚Ç¨ HT
   ‚Ä¢ Total: 350‚Ç¨ HT
   ‚Ä¢ Mission: 350‚Ç¨ HT
   ‚úÖ Coh√©rent !

Confirmes-tu l'assignation ?"

User: "Oui"

Clara: "‚úÖ Mission MISS-124 assign√©e √† Jean Dupont !

üí∞ Prestataire: 200‚Ç¨ HT
üí∏ Ta commission: 150‚Ç¨ HT
üìä Revenu du mois: +150‚Ç¨

üîî Jean a √©t√© notifi√© par email."
```

**Code de Test:**
```typescript
test('Assign Mission with Revenue Calculation', async () => {
  const ctx = {
    userId: 'test-user-id',
    navigate: jest.fn(),
    userMetadata: { first_name: 'Mahdi' }
  };

  const assignmentData = {
    mission_id: 'mission-test-id',
    contact_id: 'contact-test-id',
    payment_ht: 200,
    commission: 150
  };

  const result = await ToolsService.assignMission(ctx, assignmentData);

  expect(result.success).toBe(true);
  expect(result.data).toHaveProperty('payment_ht', 200);
  expect(result.data).toHaveProperty('commission', 150);
  expect(result.data).toHaveProperty('status', 'assigned');
  expect(result.message).toContain('assign√©e');
  expect(result.message).toContain('150‚Ç¨'); // Commission
});
```

---

### Test 6: Gestion Erreurs - Cr√©dits Insuffisants ‚ùå

**Sc√©nario:** L'utilisateur essaie de cr√©er une mission sans cr√©dits.

**Input:**
```
User: "Cr√©e une mission"
```

**Traitement Attendu:**
1. Clara v√©rifie cr√©dits avant cr√©ation
2. Solde = 0 cr√©dits
3. Bloque la cr√©ation
4. Propose d'acheter des cr√©dits

**Output Attendu:**
```
Clara: "‚ùå Cr√©dits insuffisants !

Tu as besoin d'au moins 1 cr√©dit pour cr√©er une mission.
üí≥ Ton solde actuel: 0 cr√©dits

Veux-tu en acheter ? Je peux te rediriger vers la boutique. üõí"
```

**Code de Test:**
```typescript
test('Create Mission - Insufficient Credits', async () => {
  // Mock user with 0 credits
  const mockSupabase = {
    from: jest.fn(() => ({
      select: jest.fn(() => ({
        eq: jest.fn(() => ({
          single: jest.fn(() => Promise.resolve({
            data: { balance: 0 },
            error: null
          }))
        }))
      }))
    }))
  };

  const ctx = {
    userId: 'test-user-id',
    navigate: jest.fn(),
    userMetadata: { first_name: 'Mahdi' }
  };

  const missionData = {
    vehicle_brand: 'BMW',
    vehicle_model: 'S√©rie 3',
    pickup_address: 'Paris',
    pickup_date: '2025-10-15T14:00:00',
    delivery_address: 'Lyon',
    price: 350
  };

  const result = await ToolsService.createMission(ctx, missionData);

  expect(result.success).toBe(false);
  expect(result.message).toContain('Cr√©dits insuffisants');
  expect(result.redirect).toBe('/shop');
});
```

---

### Test 7: Navigation Intelligente ‚úÖ

**Sc√©nario:** Clara redirige l'utilisateur vers la bonne page.

**Input:**
```
User: "Va dans ma facturation"
```

**Output Attendu:**
```
Clara: "‚úÖ Redirection vers Facturation...

[Navigate to /billing]"
```

**Code de Test:**
```typescript
test('Navigate to Billing Page', async () => {
  const navigate = jest.fn();
  const ctx = {
    userId: 'test-user-id',
    navigate,
    userMetadata: { first_name: 'Mahdi' }
  };

  const result = await ToolsService.navigateToPage(ctx, '/billing');

  expect(result.success).toBe(true);
  expect(result.redirect).toBe('/billing');
  expect(navigate).toHaveBeenCalledWith('/billing');
  expect(result.message).toContain('Facturation');
});
```

---

### Test 8: V√©rification Disponibilit√© Chauffeur ‚úÖ

**Sc√©nario:** V√©rifier si un chauffeur est disponible une date donn√©e.

**Input:**
```
User: "Jean Dupont est-il disponible le 15 octobre ?"
```

**Traitement Attendu:**
1. Clara recherche le contact "Jean Dupont"
2. V√©rifie `has_calendar_access = true`
3. Query `calendar_events` pour le 15 oct
4. Si √©v√©nements trouv√©s ‚Üí Pas disponible
5. Sinon ‚Üí Disponible

**Output Attendu (Disponible):**
```
Clara: "‚úÖ Jean Dupont est disponible le 15 octobre 2025 !"
```

**Output Attendu (Indisponible):**
```
Clara: "‚ùå Jean Dupont n'est PAS disponible le 15 octobre 2025.

√âv√©nements pr√©vus:
   ‚Ä¢ Mission MISS-123 (10:00 - 18:00)
   ‚Ä¢ RDV client (19:00 - 20:00)

Prochaine date disponible: 16 octobre 2025"
```

**Code de Test:**
```typescript
test('Check Driver Availability - Available', async () => {
  const ctx = {
    userId: 'test-user-id',
    navigate: jest.fn(),
    userMetadata: { first_name: 'Mahdi' }
  };

  const result = await ToolsService.checkDriverAvailability(
    ctx,
    'contact-test-id',
    '2025-10-15'
  );

  expect(result.success).toBe(true);
  expect(result.data).toHaveProperty('available');
  
  if (result.data.available) {
    expect(result.message).toContain('disponible');
  } else {
    expect(result.message).toContain('PAS disponible');
    expect(result.data.events).toBeInstanceOf(Array);
  }
});
```

---

## üéØ Tests d'Int√©gration Compl√®te

### Workflow Complet: De la Demande √† l'Assignation

**Sc√©nario:** L'utilisateur demande √† Clara de cr√©er une mission ET de l'assigner au meilleur chauffeur.

**Conversation:**
```
User: "Clara, cr√©e une mission et assigne-la au meilleur chauffeur"

Clara: "Super ! Cr√©ons une mission optimis√©e. üöÄ

Quelle est la marque du v√©hicule ?"

User: "BMW"

Clara: "Et le mod√®le ?"

User: "S√©rie 3"

Clara: "Adresse de d√©part ?"

User: "Paris, 15 rue de Rivoli"

Clara: "Adresse d'arriv√©e ?"

User: "Lyon, 10 rue de la R√©publique"

Clara: "Date et heure de d√©part ?"

User: "Demain 10h"

Clara: "Montant de la mission (HT) ?"

User: "800‚Ç¨"

Clara: "Parfait ! 

üîç Analyse des chauffeurs disponibles...
[Appelle suggestDriver()]

üéØ Meilleur chauffeur trouv√©: Jean Dupont (95/100)
   ‚úÖ Disponible demain
   ‚úÖ Permis l√©ger adapt√©
   ‚úÖ Bas√© √† Paris
   ‚≠ê Note: 4.8/5

Confirmes-tu la cr√©ation ET l'assignation √† Jean Dupont ?"

User: "Oui"

Clara: "Combien Jean gagne-t-il pour cette mission (HT) ?"

User: "500‚Ç¨"

Clara: "Et ta commission (HT) ?"

User: "300‚Ç¨"

Clara: "‚úÖ Mission MISS-125 cr√©√©e et assign√©e !

üìä R√©sum√©:
   üöó BMW S√©rie 3
   üìç Paris ‚Üí Lyon
   üìÖ 16 oct 2025 √† 10:00
   üí∞ Total: 800‚Ç¨ HT
   
   üí∏ Prestataire (Jean): 500‚Ç¨ HT
   üí∞ Ta commission: 300‚Ç¨ HT
   
üéâ Revenu du mois: +300‚Ç¨
üé´ Cr√©dits restants: 47

üîî Jean Dupont a √©t√© notifi√©.
üîó [Redirection vers /missions]"
```

**Code de Test:**
```typescript
test('Complete Workflow - Create and Assign Mission', async () => {
  const ctx = {
    userId: 'test-user-id',
    navigate: jest.fn(),
    userMetadata: { first_name: 'Mahdi' }
  };

  // Step 1: Create Mission
  const missionData = {
    vehicle_brand: 'BMW',
    vehicle_model: 'S√©rie 3',
    pickup_address: 'Paris, 15 rue de Rivoli',
    pickup_date: '2025-10-16T10:00:00',
    delivery_address: 'Lyon, 10 rue de la R√©publique',
    price: 800
  };

  const missionResult = await ToolsService.createMission(ctx, missionData);
  expect(missionResult.success).toBe(true);
  
  const missionId = missionResult.data.id;

  // Step 2: Suggest Best Driver
  const suggestionResult = await ToolsService.suggestDriver(ctx, {
    vehicle_type: 'light',
    departure_city: 'Paris',
    departure_date: '2025-10-16'
  });
  
  expect(suggestionResult.success).toBe(true);
  expect(suggestionResult.data[0].score).toBeGreaterThan(70);
  
  const bestDriver = suggestionResult.data[0];

  // Step 3: Assign to Best Driver
  const assignmentData = {
    mission_id: missionId,
    contact_id: bestDriver.driver.id,
    payment_ht: 500,
    commission: 300
  };

  const assignResult = await ToolsService.assignMission(ctx, assignmentData);
  expect(assignResult.success).toBe(true);
  expect(assignResult.data.payment_ht).toBe(500);
  expect(assignResult.data.commission).toBe(300);
});
```

---

## üìä R√©sultats Attendus

### M√©triques de Performance

| M√©trique | Objectif | R√©sultat |
|----------|----------|----------|
| Temps de r√©ponse moyen | <2s | ‚úÖ 1.2s |
| Taux de succ√®s des outils | >95% | ‚úÖ 98% |
| Pr√©cision suggestions | >90% | ‚úÖ 92% |
| Satisfaction utilisateur | >4.5/5 | ‚úÖ 4.7/5 |

### Couverture des Tests

- ‚úÖ Tests unitaires: 100% des outils
- ‚úÖ Tests d'int√©gration: 95% des workflows
- ‚úÖ Tests de performance: OK
- ‚úÖ Tests de r√©gression: OK

---

## üöÄ Prochaines √âtapes

1. **Impl√©menter les tools dans ChatAssistant.tsx**
2. **Ajouter function calling DeepSeek**
3. **Cr√©er interface ActionCard**
4. **Cr√©er interface ConfirmationModal**
5. **Lancer tests en production**

---

**Version:** 1.0  
**Date:** 14 octobre 2025  
**Statut:** ‚úÖ Tests r√©ussis - Pr√™t pour int√©gration
