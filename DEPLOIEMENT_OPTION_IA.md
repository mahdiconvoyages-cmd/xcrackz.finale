# üöÄ D√©ploiement Option IA - Guide Rapide

**Temps estim√©:** 10 minutes

---

## ‚úÖ Checklist Avant D√©ploiement

- [x] Composants Web cr√©√©s
- [x] Composants Mobile cr√©√©s
- [x] Services mis √† jour
- [x] Migration SQL pr√™te
- [x] Documentation compl√®te
- [x] Aucune erreur TypeScript

---

## üìã √âtapes de D√©ploiement

### 1Ô∏è‚É£ Base de Donn√©es (5 min)

#### Option A : Supabase CLI

```bash
# Depuis le dossier racine
cd Finality-okok

# Appliquer la migration
npx supabase db push

# V√©rifier que la colonne existe
npx supabase db query "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'inspections' AND column_name = 'use_ai';"
```

#### Option B : Dashboard Supabase (recommand√© si probl√®me CLI)

1. Ouvrir [https://dashboard.supabase.com](https://dashboard.supabase.com)
2. S√©lectionner votre projet
3. Aller dans **SQL Editor**
4. Cliquer **New query**
5. Copier le contenu de `migrations/add_use_ai_to_inspections.sql`
6. Cliquer **Run**
7. V√©rifier succ√®s : ‚úÖ "Success. No rows returned"

**V√©rification:**

```sql
-- V√©rifier colonne cr√©√©e
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'inspections' AND column_name = 'use_ai';

-- R√©sultat attendu:
-- column_name | data_type | column_default
-- use_ai      | boolean   | true

-- V√©rifier index cr√©√©
SELECT indexname FROM pg_indexes 
WHERE tablename = 'inspections' AND indexname = 'idx_inspections_use_ai';

-- R√©sultat attendu:
-- indexname
-- idx_inspections_use_ai
```

---

### 2Ô∏è‚É£ Application Web (2 min)

```bash
# Aller dans dossier web
cd Finality-okok

# Installer d√©pendances (si pas d√©j√† fait)
npm install

# V√©rifier compilation TypeScript
npx tsc --noEmit

# R√©sultat attendu: Aucune erreur

# D√©marrer en mode dev pour tester
npm run dev

# Ouvrir navigateur: http://localhost:5173
```

**Test rapide:**
1. Connexion avec compte test
2. Aller sur Missions
3. Cliquer "D√©marrer inspection"
4. V√©rifier modal s'affiche ‚úÖ
5. Tester choix OUI et NON

---

### 3Ô∏è‚É£ Application Mobile (3 min)

```bash
# Aller dans dossier mobile
cd cassa-temp

# Installer d√©pendances (si pas d√©j√† fait)
npm install

# V√©rifier compilation TypeScript
npx tsc --noEmit

# R√©sultat attendu: Aucune erreur

# D√©marrer Expo
npm start

# Scanner QR code avec Expo Go
```

**Test rapide:**
1. Connexion avec compte test
2. Aller sur Missions
3. S√©lectionner mission
4. Cliquer "Inspection d√©part"
5. V√©rifier modal s'affiche ‚úÖ
6. Tester choix OUI et NON

---

## üß™ Tests de Validation

### Test 1 : Base de Donn√©es

```sql
-- Test 1: Cr√©er inspection avec IA
INSERT INTO vehicle_inspections (
  mission_id, inspector_id, inspection_type, use_ai, status
) VALUES (
  'test-mission-1', 'test-user-1', 'departure', true, 'in_progress'
) RETURNING id, use_ai;

-- R√©sultat attendu: use_ai = true

-- Test 2: Cr√©er inspection sans IA
INSERT INTO vehicle_inspections (
  mission_id, inspector_id, inspection_type, use_ai, status
) VALUES (
  'test-mission-2', 'test-user-1', 'departure', false, 'in_progress'
) RETURNING id, use_ai;

-- R√©sultat attendu: use_ai = false

-- Nettoyage
DELETE FROM vehicle_inspections WHERE mission_id LIKE 'test-mission-%';
```

### Test 2 : Web - Modal Affichage

**√âtapes:**
1. Ouvrir `http://localhost:5173`
2. Connexion
3. Missions ‚Üí Nouvelle inspection
4. V√©rifier modal appara√Æt

**R√©sultat attendu:**
- ‚úÖ Modal visible
- ‚úÖ Titre "Assistant IA Gemini"
- ‚úÖ 2 options (OUI / NON)
- ‚úÖ Bouton Confirmer d√©sactiv√© par d√©faut

### Test 3 : Web - Choix OUI

**√âtapes:**
1. Cliquer option OUI
2. V√©rifier bordure verte
3. Cliquer Confirmer
4. Prendre une photo

**R√©sultat attendu:**
- ‚úÖ Modal se ferme
- ‚úÖ Photo prise
- ‚úÖ Description IA g√©n√©r√©e (si r√©seau)
- ‚úÖ En base: `use_ai = true`

### Test 4 : Web - Choix NON

**√âtapes:**
1. Red√©marrer inspection
2. Cliquer option NON
3. V√©rifier bordure orange
4. Cliquer Confirmer
5. Prendre une photo

**R√©sultat attendu:**
- ‚úÖ Modal se ferme
- ‚úÖ Photo prise instantan√©ment
- ‚úÖ Pas d'appel IA
- ‚úÖ En base: `use_ai = false`

### Test 5 : Mobile - Modal Affichage

**√âtapes:**
1. Ouvrir app mobile
2. Connexion
3. Missions ‚Üí Inspection d√©part
4. V√©rifier modal appara√Æt

**R√©sultat attendu:**
- ‚úÖ Modal visible plein √©cran
- ‚úÖ Header gradient bleu/violet
- ‚úÖ 2 cards s√©lectionnables
- ‚úÖ Bouton Confirmer gris√© si rien s√©lectionn√©

### Test 6 : Mobile - Choix OUI

**√âtapes:**
1. Tap sur card OUI
2. V√©rifier bordure verte + badge ‚úì
3. Tap Confirmer
4. Prendre photo

**R√©sultat attendu:**
- ‚úÖ Modal se ferme avec animation
- ‚úÖ Photo prise
- ‚úÖ Loader "Analyse IA..."
- ‚úÖ Description g√©n√©r√©e (si r√©seau)

### Test 7 : Mobile - Choix NON

**√âtapes:**
1. Red√©marrer inspection
2. Tap sur card NON
3. V√©rifier bordure orange + badge ‚úì
4. Tap Confirmer
5. Prendre photo

**R√©sultat attendu:**
- ‚úÖ Modal se ferme
- ‚úÖ Photo sauvegard√©e directement
- ‚úÖ Pas de loader IA
- ‚úÖ Pas d'attente

### Test 8 : Mode Hors Ligne

**√âtapes:**
1. Activer mode avion sur mobile
2. D√©marrer inspection
3. Choisir NON
4. Prendre 6 photos
5. Compl√©ter inspection

**R√©sultat attendu:**
- ‚úÖ Tout fonctionne
- ‚úÖ Pas d'erreur r√©seau
- ‚úÖ Inspection sauvegard√©e localement
- ‚úÖ Sync quand r√©seau revient

---

## üêõ D√©pannage

### Probl√®me 1 : Modal ne s'affiche pas (Web)

**Sympt√¥mes:**
- Inspection d√©marre directement
- Pas de modal

**Solution:**
```tsx
// V√©rifier dans InspectionWizard.tsx
const [showAIChoice, setShowAIChoice] = useState(true); // Doit √™tre true
const [aiChoiceMade, setAiChoiceMade] = useState(false); // Doit √™tre false

// V√©rifier import
import AIChoiceModal from '../components/inspection/AIChoiceModal';
```

### Probl√®me 2 : Modal ne s'affiche pas (Mobile)

**Sympt√¥mes:**
- Inspection d√©marre directement
- Pas de modal

**Solution:**
```tsx
// V√©rifier dans InspectionScreen.tsx
const [showAIChoice, setShowAIChoice] = useState(true); // Doit √™tre true
const [aiChoiceMade, setAiChoiceMade] = useState(false); // Doit √™tre false

// V√©rifier import
import AIChoiceModal from '../components/AIChoiceModal';
```

### Probl√®me 3 : Erreur SQL "column use_ai does not exist"

**Sympt√¥mes:**
- Erreur lors cr√©ation inspection
- "column use_ai does not exist"

**Solution:**
```bash
# V√©rifier que migration a √©t√© appliqu√©e
npx supabase db query "SELECT column_name FROM information_schema.columns WHERE table_name = 'vehicle_inspections' AND column_name = 'use_ai';"

# Si vide, r√©appliquer migration
npx supabase db push
```

### Probl√®me 4 : IA ne fonctionne pas m√™me avec OUI

**Sympt√¥mes:**
- Choix OUI s√©lectionn√©
- Mais pas de description IA

**Solution:**
```typescript
// V√©rifier dans InspectionScreen.tsx (mobile)
if (useAI) { // V√©rifier cette condition
  const description = await generatePhotoDescription(...);
}

// V√©rifier √©tat useAI
console.log('useAI:', useAI); // Doit √™tre true
```

### Probl√®me 5 : Erreur "AIzaSy..." API Key

**Sympt√¥mes:**
- Erreur 400 ou 403 Gemini API
- "API key not valid"

**Solution:**
```typescript
// V√©rifier dans aiService.ts
const GEMINI_API_KEY = 'AIzaSyAsIK3J6NSmvEG478oOHbIkRNp4xy4S_50';

// Tester API key manuellement
curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp?key=AIzaSyAsIK3J6NSmvEG478oOHbIkRNp4xy4S_50"

// R√©sultat attendu: JSON avec model info
```

---

## üìä Monitoring Post-D√©ploiement

### Requ√™tes Supabase Utiles

```sql
-- 1. Statistiques utilisation IA
SELECT 
  use_ai,
  COUNT(*) as inspections,
  ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM vehicle_inspections), 1) as percentage
FROM vehicle_inspections
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY use_ai;

-- 2. Inspections r√©centes avec IA
SELECT 
  id, 
  mission_id, 
  inspection_type, 
  use_ai,
  status,
  created_at
FROM vehicle_inspections
ORDER BY created_at DESC
LIMIT 20;

-- 3. Performance (temps moyen inspection)
SELECT 
  use_ai,
  AVG(EXTRACT(EPOCH FROM (completed_at - created_at)) / 60) as avg_duration_minutes
FROM vehicle_inspections
WHERE status = 'completed' AND completed_at IS NOT NULL
GROUP BY use_ai;

-- 4. Taux de compl√©tion
SELECT 
  use_ai,
  status,
  COUNT(*) as count
FROM vehicle_inspections
GROUP BY use_ai, status
ORDER BY use_ai, status;
```

### M√©triques √† Surveiller

| M√©trique | Cible | Action si hors cible |
|----------|-------|---------------------|
| % Inspections avec IA | 60-80% | V√©rifier r√©seau zones |
| Erreurs API Gemini | < 5% | Augmenter timeout |
| Temps moyen avec IA | < 20 min | Optimiser prompts |
| Temps moyen sans IA | < 12 min | OK |
| Taux compl√©tion | > 95% | Enqu√™ter bugs |

---

## ‚úÖ Checklist Post-D√©ploiement

- [ ] Migration SQL appliqu√©e avec succ√®s
- [ ] Web: Modal s'affiche correctement
- [ ] Web: Choix OUI fonctionne (IA activ√©e)
- [ ] Web: Choix NON fonctionne (mode manuel)
- [ ] Mobile: Modal s'affiche correctement
- [ ] Mobile: Choix OUI fonctionne (IA activ√©e)
- [ ] Mobile: Choix NON fonctionne (mode manuel)
- [ ] Base: Champ `use_ai` sauvegard√©
- [ ] Tests hors ligne r√©ussis
- [ ] Aucune erreur console
- [ ] Documentation √† jour
- [ ] √âquipe form√©e sur nouvelle fonctionnalit√©

---

## üìû Support

### Probl√®mes Techniques

**Contact:** Mahdi (d√©veloppeur)

**Logs √† fournir:**
```bash
# Web
# Ouvrir DevTools (F12) ‚Üí Console
# Copier erreurs rouges

# Mobile
# Terminal Expo ‚Üí Copier erreurs
```

### Feedback Utilisateurs

**Collecte:**
- Enqu√™te apr√®s 1 semaine d'utilisation
- Questions:
  1. Utilisez-vous l'option IA ? (Oui/Non)
  2. Si oui, √™tes-vous satisfait des descriptions ?
  3. Si non, pourquoi ? (R√©seau / Urgence / Autre)
  4. Suggestions d'am√©lioration ?

---

## üéâ F√©licitations !

Si tous les tests passent :

‚úÖ **D√©ploiement r√©ussi !**  
‚úÖ **Fonctionnalit√© op√©rationnelle**  
‚úÖ **Pr√™t pour production**

---

**Date:** 15 Octobre 2025  
**Version:** 1.0  
**Status:** ‚úÖ D√©ployable
