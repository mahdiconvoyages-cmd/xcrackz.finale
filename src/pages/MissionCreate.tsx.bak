// @ts-nocheck
// Cr√©ation de mission - VERSION IDENTIQUE √Ä FLUTTER
// 3 √©tapes : Mandataire+V√©hicule, Enl√®vement, Livraison+Options
import { useState, useEffect, useRef, useCallback } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { ArrowLeft, Save, Truck, X, ChevronRight, ChevronLeft, MapPin, Search } from 'lucide-react';
import { supabase } from '../lib/supabase';
import { useAuth } from '../contexts/AuthContext';
import { useCredits } from '../hooks/useCredits';
import BuyCreditModal from '../components/BuyCreditModal';

// === Autocomplete adresses via api-adresse.data.gouv.fr (identique Flutter) ===
interface AddressSuggestion {
  label: string;
  name: string;
  city: string;
  postcode: string;
  latitude: number;
  longitude: number;
}

async function searchAddresses(query: string): Promise<AddressSuggestion[]> {
  if (!query || query.length < 3) return [];
  try {
    const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
    const data = await res.json();
    return (data.features || []).map((f: any) => ({
      label: f.properties.label || '',
      name: f.properties.name || '',
      city: f.properties.city || '',
      postcode: f.properties.postcode || '',
      latitude: f.geometry?.coordinates?.[1] || 0,
      longitude: f.geometry?.coordinates?.[0] || 0,
    }));
  } catch {
    return [];
  }
}

// === Composant champ d'adresse avec autocompl√©tion ===
function AddressAutocompleteField({ label, value, onChange, onSelect, placeholder, required: isRequired }: {
  label: string;
  value: string;
  onChange: (v: string) => void;
  onSelect: (s: AddressSuggestion) => void;
  placeholder: string;
  required?: boolean;
}) {
  const [suggestions, setSuggestions] = useState<AddressSuggestion[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const debounceRef = useRef<NodeJS.Timeout>();
  const wrapperRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (wrapperRef.current && !wrapperRef.current.contains(e.target as Node)) {
        setShowSuggestions(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleInputChange = useCallback((val: string) => {
    onChange(val);
    if (debounceRef.current) clearTimeout(debounceRef.current);
    if (val.length < 3) { setSuggestions([]); setShowSuggestions(false); return; }
    debounceRef.current = setTimeout(async () => {
      const results = await searchAddresses(val);
      setSuggestions(results);
      setShowSuggestions(results.length > 0);
    }, 300);
  }, [onChange]);

  return (
    <div ref={wrapperRef} className="relative">
      <label className="block text-sm font-semibold mb-2">{label}</label>
      <div className="relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
        <input type="text" value={value} onChange={(e) => handleInputChange(e.target.value)}
          placeholder={placeholder} required={isRequired}
          className="w-full bg-slate-50 border-2 border-slate-200 rounded-lg pl-10 pr-4 py-3 focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
      </div>
      {showSuggestions && (
        <div className="absolute z-50 w-full mt-1 bg-white border-2 border-slate-200 rounded-xl shadow-xl max-h-60 overflow-y-auto">
          {suggestions.map((s, i) => (
            <button key={i} type="button"
              className="w-full text-left px-4 py-3 hover:bg-teal-50 flex items-start gap-3 border-b last:border-0 transition-colors"
              onClick={() => { onSelect(s); setShowSuggestions(false); setSuggestions([]); }}>
              <MapPin className="w-4 h-4 text-teal-500 mt-0.5 flex-shrink-0" />
              <span className="text-sm text-slate-700">{s.label}</span>
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

// === Composant principal ===
export default function MissionCreate() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const { credits, deductCredits, hasEnoughCredits } = useCredits();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [showBuyCreditModal, setShowBuyCreditModal] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const totalSteps = 3; // Identique Flutter : 0=V√©hicule, 1=Enl√®vement, 2=Livraison+Options

  const [formData, setFormData] = useState({
    reference: `MSN${Date.now().toString().substring(5)}`,
    // √âtape 0 - Mandataire + V√©hicule
    mandataire_name: '',
    mandataire_company: '',
    vehicle_brand: '',
    vehicle_model: '',
    vehicle_type: 'VL' as 'VL' | 'VU' | 'PL',
    vehicle_plate: '',
    vehicle_vin: '',
    // √âtape 1 - Enl√®vement
    pickup_address: '',
    pickup_postcode: '',
    pickup_city: '',
    pickup_lat: null as number | null,
    pickup_lng: null as number | null,
    pickup_date: '',
    pickup_time: '',
    pickup_contact_name: '',
    pickup_contact_phone: '',
    // √âtape 2 - Livraison + Options
    delivery_address: '',
    delivery_postcode: '',
    delivery_city: '',
    delivery_lat: null as number | null,
    delivery_lng: null as number | null,
    delivery_date: '',
    delivery_time: '',
    delivery_contact_name: '',
    delivery_contact_phone: '',
    price: '',
    notes: '',
    // Restitution
    has_restitution: false,
    restitution_pickup_same_as_delivery: true,
    restitution_delivery_same_as_pickup: true,
    restitution_pickup_address: '',
    restitution_pickup_postcode: '',
    restitution_pickup_city: '',
    restitution_pickup_lat: null as number | null,
    restitution_pickup_lng: null as number | null,
    restitution_pickup_date: '',
    restitution_pickup_time: '',
    restitution_pickup_contact_name: '',
    restitution_pickup_contact_phone: '',
    restitution_delivery_address: '',
    restitution_delivery_postcode: '',
    restitution_delivery_city: '',
    restitution_delivery_lat: null as number | null,
    restitution_delivery_lng: null as number | null,
    restitution_delivery_contact_name: '',
    restitution_delivery_contact_phone: '',
    restitution_delivery_date: '',
    restitution_delivery_time: '',
    restitution_vehicle_brand: '',
    restitution_vehicle_model: '',
    restitution_vehicle_plate: '',
  });

  const requiredCredits = formData.has_restitution ? 2 : 1;

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    setFormData((prev) => ({ ...prev, [e.target.name]: e.target.value }));
  };

  const handleNext = () => currentStep < totalSteps - 1 && setCurrentStep(currentStep + 1);
  const handlePrevious = () => currentStep > 0 && setCurrentStep(currentStep - 1);

  const canProceed = () => {
    switch (currentStep) {
      case 0: return formData.mandataire_name && formData.vehicle_brand && formData.vehicle_model;
      case 1: return formData.pickup_address && formData.pickup_city && formData.pickup_contact_name && formData.pickup_date;
      case 2: {
        const deliveryOk = formData.delivery_address && formData.delivery_city && formData.delivery_contact_name && formData.delivery_date;
        if (!deliveryOk) return false;
        if (formData.has_restitution) {
          if (!formData.restitution_pickup_date) return false;
          if (!formData.restitution_pickup_same_as_delivery &&
              (!formData.restitution_pickup_address || !formData.restitution_pickup_city)) return false;
          if (!formData.restitution_delivery_same_as_pickup &&
              (!formData.restitution_delivery_address || !formData.restitution_delivery_city)) return false;
        }
        return true;
      }
      default: return false;
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !hasEnoughCredits(requiredCredits)) {
      setShowBuyCreditModal(true);
      return;
    }

    setLoading(true);
    setError('');

    try {
      const deductResult = await deductCredits(requiredCredits, `Cr√©ation mission ${formData.reference}${formData.has_restitution ? ' + restitution' : ''}`);
      if (!deductResult.success) throw new Error(deductResult.error);

      const pickupDateTime = formData.pickup_time ? `${formData.pickup_date}T${formData.pickup_time}` : formData.pickup_date;
      const deliveryDateTime = formData.delivery_time ? `${formData.delivery_date}T${formData.delivery_time}` : formData.delivery_date;

      const pickupAddr = `${formData.pickup_address}, ${formData.pickup_postcode} ${formData.pickup_city}`;
      const deliveryAddr = `${formData.delivery_address}, ${formData.delivery_postcode} ${formData.delivery_city}`;

      const insertData: any = {
          user_id: user.id,
          reference: formData.reference,
          status: 'pending',
          mandataire_name: formData.mandataire_name.trim() || null,
          mandataire_company: formData.mandataire_company.trim() || null,
          vehicle_brand: formData.vehicle_brand.trim(),
          vehicle_model: formData.vehicle_model.trim(),
          vehicle_type: formData.vehicle_type,
          vehicle_plate: formData.vehicle_plate.trim().toUpperCase() || null,
          vehicle_vin: formData.vehicle_vin.trim().toUpperCase() || null,
          pickup_address: pickupAddr,
          pickup_city: formData.pickup_city.trim(),
          pickup_postal_code: formData.pickup_postcode.trim(),
          pickup_lat: formData.pickup_lat,
          pickup_lng: formData.pickup_lng,
          pickup_date: pickupDateTime || null,
          pickup_contact_name: formData.pickup_contact_name.trim() || null,
          pickup_contact_phone: formData.pickup_contact_phone.trim() || null,
          delivery_address: deliveryAddr,
          delivery_city: formData.delivery_city.trim(),
          delivery_postal_code: formData.delivery_postcode.trim(),
          delivery_lat: formData.delivery_lat,
          delivery_lng: formData.delivery_lng,
          delivery_date: deliveryDateTime || null,
          delivery_contact_name: formData.delivery_contact_name.trim() || null,
          delivery_contact_phone: formData.delivery_contact_phone.trim() || null,
          price: formData.price ? parseFloat(formData.price) : null,
          notes: formData.notes.trim() || null,
          has_restitution: formData.has_restitution,
      };

      // Ajouter les champs restitution si activ√©e
      if (formData.has_restitution) {
        const restPickupAddr = formData.restitution_pickup_same_as_delivery
          ? deliveryAddr
          : `${formData.restitution_pickup_address}, ${formData.restitution_pickup_postcode} ${formData.restitution_pickup_city}`;
        const restDeliveryAddr = formData.restitution_delivery_same_as_pickup
          ? pickupAddr
          : `${formData.restitution_delivery_address}, ${formData.restitution_delivery_postcode} ${formData.restitution_delivery_city}`;
        const restPickupDateTime = formData.restitution_pickup_time
          ? `${formData.restitution_pickup_date}T${formData.restitution_pickup_time}`
          : formData.restitution_pickup_date;

        Object.assign(insertData, {
          restitution_pickup_address: restPickupAddr,
          restitution_pickup_city: formData.restitution_pickup_same_as_delivery
            ? formData.delivery_city.trim() : formData.restitution_pickup_city.trim(),
          restitution_pickup_postal_code: formData.restitution_pickup_same_as_delivery
            ? formData.delivery_postcode.trim() : formData.restitution_pickup_postcode.trim(),
          restitution_pickup_lat: formData.restitution_pickup_same_as_delivery
            ? formData.delivery_lat : formData.restitution_pickup_lat,
          restitution_pickup_lng: formData.restitution_pickup_same_as_delivery
            ? formData.delivery_lng : formData.restitution_pickup_lng,
          restitution_pickup_date: restPickupDateTime || null,
          restitution_pickup_contact_name: formData.restitution_pickup_same_as_delivery
            ? (formData.delivery_contact_name.trim() || null)
            : (formData.restitution_pickup_contact_name.trim() || null),
          restitution_pickup_contact_phone: formData.restitution_pickup_same_as_delivery
            ? (formData.delivery_contact_phone.trim() || null)
            : (formData.restitution_pickup_contact_phone.trim() || null),
          restitution_delivery_address: restDeliveryAddr,
          restitution_delivery_city: formData.restitution_delivery_same_as_pickup
            ? formData.pickup_city.trim() : formData.restitution_delivery_city.trim(),
          restitution_delivery_postal_code: formData.restitution_delivery_same_as_pickup
            ? formData.pickup_postcode.trim() : formData.restitution_delivery_postcode.trim(),
          restitution_delivery_lat: formData.restitution_delivery_same_as_pickup
            ? formData.pickup_lat : formData.restitution_delivery_lat,
          restitution_delivery_lng: formData.restitution_delivery_same_as_pickup
            ? formData.pickup_lng : formData.restitution_delivery_lng,
          restitution_delivery_contact_name: formData.restitution_delivery_same_as_pickup
            ? (formData.pickup_contact_name.trim() || null)
            : (formData.restitution_delivery_contact_name.trim() || null),
          restitution_delivery_contact_phone: formData.restitution_delivery_same_as_pickup
            ? (formData.pickup_contact_phone.trim() || null)
            : (formData.restitution_delivery_contact_phone.trim() || null),
          restitution_delivery_date: formData.restitution_delivery_date
            ? (formData.restitution_delivery_time ? `${formData.restitution_delivery_date}T${formData.restitution_delivery_time}` : formData.restitution_delivery_date)
            : null,
          restitution_vehicle_brand: formData.restitution_vehicle_brand.trim() || null,
          restitution_vehicle_model: formData.restitution_vehicle_model.trim() || null,
          restitution_vehicle_plate: formData.restitution_vehicle_plate.trim().toUpperCase() || null,
        });
      }

      const { error: insertError } = await supabase
        .from('missions')
        .insert(insertData);

      if (insertError) throw insertError;

      alert(`‚úÖ Mission cr√©√©e ! ${requiredCredits} cr√©dit${requiredCredits > 1 ? 's' : ''} d√©duit${requiredCredits > 1 ? 's' : ''}.`);
      navigate('/team-missions');
    } catch (err: any) {
      console.error(err);
      setError(err.message || 'Erreur lors de la cr√©ation');
    } finally {
      setLoading(false);
    }
  };

  const stepLabels = ['V√©hicule', 'Enl√®vement', 'Livraison'];
  const getStepTitle = () => stepLabels[currentStep];

  const renderStep = () => {
    switch (currentStep) {
      // ======================================
      // √âTAPE 0 : MANDATAIRE + V√âHICULE
      // ======================================
      case 0:
        return (
          <div className="space-y-6">
            {/* Mandataire */}
            <div className="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border-2 border-purple-200">
              <h3 className="text-xl font-bold text-purple-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">üë§</span>
                Mandataire
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-purple-900 mb-2">Nom du mandataire *</label>
                  <input type="text" name="mandataire_name" value={formData.mandataire_name} onChange={handleChange} placeholder="Jean Dupont" required
                    className="w-full bg-white border-2 border-purple-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500" />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-purple-900 mb-2">Soci√©t√© mandante</label>
                  <input type="text" name="mandataire_company" value={formData.mandataire_company} onChange={handleChange} placeholder="Transport Express SARL"
                    className="w-full bg-white border-2 border-purple-200 rounded-lg px-4 py-3" />
                </div>
              </div>
            </div>

            {/* V√©hicule */}
            <div className="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-6 border-2 border-teal-200">
              <h3 className="text-xl font-bold text-teal-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">üöó</span>
                V√©hicule
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-teal-900 mb-2">Type de v√©hicule *</label>
                  <div className="flex gap-3">
                    {[
                      { value: 'VL', label: 'Voiture', icon: 'üöó' },
                      { value: 'VU', label: 'Utilitaire', icon: 'üöê' },
                      { value: 'PL', label: 'Poids lourd', icon: 'üöõ' },
                    ].map(({ value, label, icon }) => (
                      <button key={value} type="button" onClick={() => setFormData(prev => ({ ...prev, vehicle_type: value as any }))}
                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-all ${formData.vehicle_type === value
                          ? 'bg-teal-600 text-white shadow-lg scale-[1.02]'
                          : 'bg-white border-2 border-teal-200 hover:border-teal-400'}`}>
                        <span className="text-xl block">{icon}</span>
                        <span className="text-xs mt-1 block">{label}</span>
                      </button>
                    ))}
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-teal-900 mb-2">Marque *</label>
                  <input type="text" name="vehicle_brand" value={formData.vehicle_brand} onChange={handleChange} placeholder="Renault, Peugeot..." required
                    className="w-full bg-white border-2 border-teal-200 rounded-lg px-4 py-3" />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-teal-900 mb-2">Mod√®le *</label>
                  <input type="text" name="vehicle_model" value={formData.vehicle_model} onChange={handleChange} placeholder="Clio, 308..." required
                    className="w-full bg-white border-2 border-teal-200 rounded-lg px-4 py-3" />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-teal-900 mb-2">Immatriculation</label>
                  <input type="text" name="vehicle_plate" value={formData.vehicle_plate} onChange={handleChange} placeholder="AB-123-CD"
                    className="w-full bg-white border-2 border-teal-200 rounded-lg px-4 py-3 uppercase" />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-teal-900 mb-2">Num√©ro VIN</label>
                  <input type="text" name="vehicle_vin" value={formData.vehicle_vin} onChange={handleChange} placeholder="Num√©ro de s√©rie"
                    className="w-full bg-white border-2 border-teal-200 rounded-lg px-4 py-3 uppercase" />
                </div>
              </div>
            </div>
          </div>
        );

      // ======================================
      // √âTAPE 1 : ENL√àVEMENT
      // ======================================
      case 1:
        return (
          <div className="space-y-6">
            {/* Lieu d'enl√®vement */}
            <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-200">
              <h3 className="text-xl font-bold text-green-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">üìç</span>
                Lieu d'enl√®vement
              </h3>
              <div className="space-y-4">
                <AddressAutocompleteField
                  label="Adresse *"
                  value={formData.pickup_address}
                  onChange={(v) => setFormData(prev => ({ ...prev, pickup_address: v }))}
                  onSelect={(s) => setFormData(prev => ({
                    ...prev,
                    pickup_address: s.name,
                    pickup_city: s.city,
                    pickup_postcode: s.postcode,
                    pickup_lat: s.latitude,
                    pickup_lng: s.longitude,
                  }))}
                  placeholder="Tapez une adresse..."
                  required
                />
                <div className="grid grid-cols-1 sm:grid-cols-5 gap-3 sm:gap-4">
                  <div className="sm:col-span-2">
                    <label className="block text-sm font-semibold mb-2">Code postal</label>
                    <input type="text" name="pickup_postcode" value={formData.pickup_postcode} onChange={handleChange} placeholder="75001" maxLength={5}
                      className="w-full bg-white border-2 border-green-200 rounded-lg px-4 py-3" />
                  </div>
                  <div className="sm:col-span-3">
                    <label className="block text-sm font-semibold mb-2">Ville *</label>
                    <input type="text" name="pickup_city" value={formData.pickup_city} onChange={handleChange} placeholder="Paris" required
                      className="w-full bg-white border-2 border-green-200 rounded-lg px-4 py-3" />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold mb-2">Date *</label>
                    <input type="date" name="pickup_date" value={formData.pickup_date} onChange={handleChange} required
                      className="w-full bg-white border-2 border-green-200 rounded-lg px-4 py-3" />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold mb-2">Heure</label>
                    <input type="time" name="pickup_time" value={formData.pickup_time} onChange={handleChange}
                      className="w-full bg-white border-2 border-green-200 rounded-lg px-4 py-3" />
                  </div>
                </div>
              </div>
            </div>

            {/* Exp√©diteur */}
            <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-200">
              <h3 className="text-xl font-bold text-green-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">üë§</span>
                Exp√©diteur (contact sur place)
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold mb-2">Nom de l'exp√©diteur *</label>
                  <input type="text" name="pickup_contact_name" value={formData.pickup_contact_name} onChange={handleChange} placeholder="Jean Dupont" required
                    className="w-full bg-white border-2 border-green-200 rounded-lg px-4 py-3" />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2">T√©l√©phone</label>
                  <input type="tel" name="pickup_contact_phone" value={formData.pickup_contact_phone} onChange={handleChange} placeholder="06 XX XX XX XX"
                    className="w-full bg-white border-2 border-green-200 rounded-lg px-4 py-3" />
                </div>
              </div>
            </div>
          </div>
        );

      // ======================================
      // √âTAPE 2 : LIVRAISON + OPTIONS
      // ======================================
      case 2:
        return (
          <div className="space-y-6">
            {/* Lieu de livraison */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
              <h3 className="text-xl font-bold text-blue-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">üéØ</span>
                Lieu de livraison
              </h3>
              <div className="space-y-4">
                <AddressAutocompleteField
                  label="Adresse *"
                  value={formData.delivery_address}
                  onChange={(v) => setFormData(prev => ({ ...prev, delivery_address: v }))}
                  onSelect={(s) => setFormData(prev => ({
                    ...prev,
                    delivery_address: s.name,
                    delivery_city: s.city,
                    delivery_postcode: s.postcode,
                    delivery_lat: s.latitude,
                    delivery_lng: s.longitude,
                  }))}
                  placeholder="Tapez une adresse..."
                  required
                />
                <div className="grid grid-cols-1 sm:grid-cols-5 gap-3 sm:gap-4">
                  <div className="sm:col-span-2">
                    <label className="block text-sm font-semibold mb-2">Code postal</label>
                    <input type="text" name="delivery_postcode" value={formData.delivery_postcode} onChange={handleChange} placeholder="75008" maxLength={5}
                      className="w-full bg-white border-2 border-blue-200 rounded-lg px-4 py-3" />
                  </div>
                  <div className="sm:col-span-3">
                    <label className="block text-sm font-semibold mb-2">Ville *</label>
                    <input type="text" name="delivery_city" value={formData.delivery_city} onChange={handleChange} placeholder="Paris" required
                      className="w-full bg-white border-2 border-blue-200 rounded-lg px-4 py-3" />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold mb-2">Date *</label>
                    <input type="date" name="delivery_date" value={formData.delivery_date} onChange={handleChange} required
                      className="w-full bg-white border-2 border-blue-200 rounded-lg px-4 py-3" />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold mb-2">Heure</label>
                    <input type="time" name="delivery_time" value={formData.delivery_time} onChange={handleChange}
                      className="w-full bg-white border-2 border-blue-200 rounded-lg px-4 py-3" />
                  </div>
                </div>
              </div>
            </div>

            {/* R√©ceptionnaire */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
              <h3 className="text-xl font-bold text-blue-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">üë§</span>
                R√©ceptionnaire (contact sur place)
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold mb-2">Nom du r√©ceptionnaire *</label>
                  <input type="text" name="delivery_contact_name" value={formData.delivery_contact_name} onChange={handleChange} placeholder="Marie Martin" required
                    className="w-full bg-white border-2 border-blue-200 rounded-lg px-4 py-3" />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2">T√©l√©phone</label>
                  <input type="tel" name="delivery_contact_phone" value={formData.delivery_contact_phone} onChange={handleChange} placeholder="06 XX XX XX XX"
                    className="w-full bg-white border-2 border-blue-200 rounded-lg px-4 py-3" />
                </div>
              </div>
            </div>

            {/* Options */}
            <div className="bg-gradient-to-r from-indigo-50 to-violet-50 rounded-xl p-6 border-2 border-indigo-200">
              <h3 className="text-xl font-bold text-indigo-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">‚öôÔ∏è</span>
                Options
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold mb-2">Prix (‚Ç¨)</label>
                  <input type="number" name="price" value={formData.price} onChange={handleChange} placeholder="0.00" step="0.01"
                    className="w-full bg-white border-2 border-indigo-200 rounded-lg px-4 py-3" />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2">Notes internes</label>
                  <textarea name="notes" value={formData.notes} onChange={handleChange} rows={3} placeholder="Informations compl√©mentaires..."
                    className="w-full bg-white border-2 border-indigo-200 rounded-lg px-4 py-3 resize-none" />
                </div>
              </div>
            </div>

            {/* Restitution */}
            <div className="bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl p-6 border-2 border-orange-200">
              <h3 className="text-xl font-bold text-orange-900 mb-4 flex items-center gap-3">
                <span className="text-3xl">üîÑ</span>
                Restitution
              </h3>
              <div className="space-y-4">
                {/* Toggle */}
                <label className="flex items-center justify-between cursor-pointer">
                  <div>
                    <span className="font-semibold text-orange-900">Ajouter une restitution</span>
                    <p className="text-sm text-orange-700">
                      {formData.has_restitution ? 'Trajet retour inclus (2 cr√©dits)' : 'Aller simple (1 cr√©dit)'}
                    </p>
                  </div>
                  <div className="relative">
                    <input type="checkbox" className="sr-only peer" checked={formData.has_restitution}
                      onChange={(e) => setFormData(prev => ({ ...prev, has_restitution: e.target.checked }))} />
                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                  </div>
                </label>

                {formData.has_restitution && (
                  <div className="space-y-5 pt-4 border-t border-orange-200">
                    {/* V√©hicule restitution (Flutter parity) */}
                    <div>
                      <h4 className="font-bold text-orange-800 mb-3">üöó V√©hicule restitution</h4>
                      <div className="space-y-3">
                        <div>
                          <label className="block text-sm font-semibold mb-1">Marque du v√©hicule</label>
                          <input type="text" value={formData.restitution_vehicle_brand}
                            onChange={(e) => setFormData(prev => ({ ...prev, restitution_vehicle_brand: e.target.value }))}
                            placeholder="Renault, Peugeot..."
                            className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold mb-1">Mod√®le</label>
                          <input type="text" value={formData.restitution_vehicle_model}
                            onChange={(e) => setFormData(prev => ({ ...prev, restitution_vehicle_model: e.target.value }))}
                            placeholder="Clio, 308..."
                            className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold mb-1">Immatriculation *</label>
                          <input type="text" value={formData.restitution_vehicle_plate}
                            onChange={(e) => setFormData(prev => ({ ...prev, restitution_vehicle_plate: e.target.value }))}
                            placeholder="AB-123-CD" required
                            className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5 uppercase" />
                        </div>
                      </div>
                    </div>

                    {/* D√©part restitution */}
                    <div>
                      <h4 className="font-bold text-orange-800 mb-3">üìç D√©part restitution</h4>
                      <label className="flex items-center gap-3 mb-3 cursor-pointer">
                        <input type="checkbox" checked={formData.restitution_pickup_same_as_delivery}
                          onChange={(e) => setFormData(prev => ({ ...prev, restitution_pickup_same_as_delivery: e.target.checked }))}
                          className="w-4 h-4 text-orange-600 border-orange-300 rounded focus:ring-orange-500" />
                        <span className="text-sm font-medium text-orange-800">M√™me adresse que la livraison</span>
                      </label>
                      {!formData.restitution_pickup_same_as_delivery && (
                        <div className="space-y-3">
                          <AddressAutocompleteField
                            label="Adresse *" value={formData.restitution_pickup_address}
                            onChange={(v) => setFormData(prev => ({ ...prev, restitution_pickup_address: v }))}
                            onSelect={(s) => setFormData(prev => ({
                              ...prev, restitution_pickup_address: s.name,
                              restitution_pickup_city: s.city, restitution_pickup_postcode: s.postcode,
                              restitution_pickup_lat: s.latitude, restitution_pickup_lng: s.longitude,
                            }))}
                            placeholder="Adresse de d√©part restitution..." required
                          />
                          <div className="grid grid-cols-5 gap-3">
                            <div className="col-span-2">
                              <label className="block text-sm font-semibold mb-1">Code postal</label>
                              <input type="text" value={formData.restitution_pickup_postcode}
                                onChange={(e) => setFormData(prev => ({ ...prev, restitution_pickup_postcode: e.target.value }))}
                                className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                            </div>
                            <div className="col-span-3">
                              <label className="block text-sm font-semibold mb-1">Ville *</label>
                              <input type="text" value={formData.restitution_pickup_city}
                                onChange={(e) => setFormData(prev => ({ ...prev, restitution_pickup_city: e.target.value }))}
                                className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" required />
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1">Contact sur place</label>
                            <input type="text" value={formData.restitution_pickup_contact_name}
                              onChange={(e) => setFormData(prev => ({ ...prev, restitution_pickup_contact_name: e.target.value }))}
                              className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1">T√©l√©phone</label>
                            <input type="tel" value={formData.restitution_pickup_contact_phone}
                              onChange={(e) => setFormData(prev => ({ ...prev, restitution_pickup_contact_phone: e.target.value }))}
                              className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Date restitution */}
                    <div>
                      <h4 className="font-bold text-orange-800 mb-3">üìÖ Date de restitution *</h4>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-semibold mb-1">Date *</label>
                          <input type="date" value={formData.restitution_pickup_date}
                            onChange={(e) => setFormData(prev => ({ ...prev, restitution_pickup_date: e.target.value }))}
                            className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" required />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold mb-1">Heure</label>
                          <input type="time" value={formData.restitution_pickup_time}
                            onChange={(e) => setFormData(prev => ({ ...prev, restitution_pickup_time: e.target.value }))}
                            className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                        </div>
                      </div>
                    </div>

                    {/* Livraison restitution */}
                    <div>
                      <h4 className="font-bold text-orange-800 mb-3">üéØ Livraison restitution</h4>
                      <div className="mb-3">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-semibold mb-1">Date livraison</label>
                            <input type="date" value={formData.restitution_delivery_date}
                              onChange={(e) => setFormData(prev => ({ ...prev, restitution_delivery_date: e.target.value }))}
                              className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1">Heure livraison</label>
                            <input type="time" value={formData.restitution_delivery_time}
                              onChange={(e) => setFormData(prev => ({ ...prev, restitution_delivery_time: e.target.value }))}
                              className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                          </div>
                        </div>
                      </div>
                      <label className="flex items-center gap-3 mb-3 cursor-pointer">
                        <input type="checkbox" checked={formData.restitution_delivery_same_as_pickup}
                          onChange={(e) => setFormData(prev => ({ ...prev, restitution_delivery_same_as_pickup: e.target.checked }))}
                          className="w-4 h-4 text-orange-600 border-orange-300 rounded focus:ring-orange-500" />
                        <span className="text-sm font-medium text-orange-800">M√™me adresse que l'enl√®vement</span>
                      </label>
                      {!formData.restitution_delivery_same_as_pickup && (
                        <div className="space-y-3">
                          <AddressAutocompleteField
                            label="Adresse *" value={formData.restitution_delivery_address}
                            onChange={(v) => setFormData(prev => ({ ...prev, restitution_delivery_address: v }))}
                            onSelect={(s) => setFormData(prev => ({
                              ...prev, restitution_delivery_address: s.name,
                              restitution_delivery_city: s.city, restitution_delivery_postcode: s.postcode,
                              restitution_delivery_lat: s.latitude, restitution_delivery_lng: s.longitude,
                            }))}
                            placeholder="Adresse de livraison restitution..." required
                          />
                          <div className="grid grid-cols-5 gap-3">
                            <div className="col-span-2">
                              <label className="block text-sm font-semibold mb-1">Code postal</label>
                              <input type="text" value={formData.restitution_delivery_postcode}
                                onChange={(e) => setFormData(prev => ({ ...prev, restitution_delivery_postcode: e.target.value }))}
                                className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                            </div>
                            <div className="col-span-3">
                              <label className="block text-sm font-semibold mb-1">Ville *</label>
                              <input type="text" value={formData.restitution_delivery_city}
                                onChange={(e) => setFormData(prev => ({ ...prev, restitution_delivery_city: e.target.value }))}
                                className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" required />
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1">Contact sur place</label>
                            <input type="text" value={formData.restitution_delivery_contact_name}
                              onChange={(e) => setFormData(prev => ({ ...prev, restitution_delivery_contact_name: e.target.value }))}
                              className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1">T√©l√©phone</label>
                            <input type="tel" value={formData.restitution_delivery_contact_phone}
                              onChange={(e) => setFormData(prev => ({ ...prev, restitution_delivery_contact_phone: e.target.value }))}
                              className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5" />
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );

      default: return null;
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="flex items-center gap-4">
        <Link to="/team-missions" className="p-2 hover:bg-slate-100 rounded-lg transition"><ArrowLeft className="w-6 h-6" /></Link>
        <div>
          <h1 className="text-2xl sm:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-teal-600 to-cyan-600 bg-clip-text text-transparent">Nouvelle mission</h1>
          <p className="text-slate-600 text-sm sm:text-lg">{getStepTitle()}</p>
        </div>
      </div>

      {/* Cr√©dits */}
      <div className="bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl p-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-amber-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg">{credits}</div>
            <div>
              <p className="font-semibold text-amber-900">Cr√©dits disponibles</p>
              <p className="text-sm text-amber-700">{requiredCredits} cr√©dit{requiredCredits > 1 ? 's' : ''} sera{requiredCredits > 1 ? 'ont' : ''} d√©duit{requiredCredits > 1 ? 's' : ''} pour cette mission{formData.has_restitution ? ' + restitution' : ''}</p>
            </div>
          </div>
          {credits === 0 && (
            <button type="button" onClick={() => setShowBuyCreditModal(true)}
              className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-semibold">Recharger</button>
          )}
        </div>
      </div>

      {/* Formulaire */}
      <div className="backdrop-blur-xl bg-white/70 border rounded-xl sm:rounded-2xl p-4 sm:p-8 shadow-xl">
        {/* Progress bar - 3 √©tapes comme Flutter */}
        <div className="mb-8">
          <div className="h-3 bg-slate-200 rounded-full overflow-hidden">
            <div className="h-full bg-gradient-to-r from-teal-500 to-cyan-500 transition-all duration-500 relative"
              style={{ width: `${((currentStep + 1) / totalSteps) * 100}%` }}>
              <div className="absolute right-0 top-1/2 -translate-y-1/2 -mr-4 animate-bounce">
                <Truck className="w-8 h-8 text-teal-600 drop-shadow-lg" />
              </div>
            </div>
          </div>
          <div className="flex justify-between mt-4">
            {stepLabels.map((label, i) => (
              <div key={i} className={`flex items-center gap-2 text-sm font-semibold transition-colors ${i <= currentStep ? 'text-teal-600' : 'text-slate-400'}`}>
                {i < currentStep ? (
                  <span className="w-6 h-6 rounded-full bg-teal-500 text-white flex items-center justify-center text-xs">‚úì</span>
                ) : (
                  <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${i === currentStep ? 'bg-teal-500 text-white' : 'bg-slate-200 text-slate-500'}`}>{i + 1}</span>
                )}
                <span className="hidden sm:inline">{label}</span>
              </div>
            ))}
          </div>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl mb-6 flex items-start gap-3">
            <X className="w-5 h-5 flex-shrink-0 mt-0.5" /><div>{error}</div>
          </div>
        )}

        <form onSubmit={handleSubmit}>
          <div className="min-h-[500px]">{renderStep()}</div>

          {/* Navigation identique Flutter */}
          <div className="flex gap-4 mt-8 pt-6 border-t">
            {currentStep > 0 && (
              <button type="button" onClick={handlePrevious}
                className="flex-1 px-6 py-4 border-2 text-slate-700 rounded-xl hover:bg-slate-50 font-semibold flex items-center justify-center gap-2 transition">
                <ChevronLeft className="w-5 h-5" />Pr√©c√©dent
              </button>
            )}
            {currentStep < totalSteps - 1 ? (
              <button type="button" onClick={handleNext} disabled={!canProceed()}
                className="flex-1 px-6 py-4 bg-gradient-to-r from-teal-500 to-cyan-500 text-white rounded-xl hover:from-teal-600 hover:to-cyan-600 disabled:opacity-50 font-semibold flex items-center justify-center gap-2 shadow-lg transition">
                Continuer<ChevronRight className="w-5 h-5" />
              </button>
            ) : (
              <button type="submit" disabled={loading || !hasEnoughCredits(requiredCredits)}
                className="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl hover:from-green-600 hover:to-emerald-600 disabled:opacity-50 font-semibold flex items-center justify-center gap-2 shadow-lg transition">
                {loading ? (
                  <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />Cr√©ation...</>
                ) : (
                  <><Save className="w-5 h-5" />Cr√©er la mission</>
                )}
              </button>
            )}
          </div>
        </form>
      </div>

      {showBuyCreditModal && <BuyCreditModal isOpen={showBuyCreditModal} onClose={() => setShowBuyCreditModal(false)} />}
    </div>
  );
}
