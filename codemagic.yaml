workflows:
  ios-testflight:
    name: iOS TestFlight
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      flutter: 3.38.2
      xcode: latest
      cocoapods: default
      groups:
        - signing
      vars:
        BUNDLE_ID: "com.checksfleet.app"
        APPLE_TEAM_ID: "P35Y6M742T"
    integrations:
      app_store_connect: checksfleet
    scripts:
      - name: Get Flutter packages
        script: |
          cd mobile_flutter/finality_app
          flutter pub get
      
      - name: Generate app icons
        script: |
          cd mobile_flutter/finality_app
          dart run flutter_launcher_icons
          echo "✅ App icons generated from logo.png"

      - name: Create .env file
        script: |
          cd mobile_flutter/finality_app
          cat > .env << EOF
          SUPABASE_URL=https://lqrulgkavtzummbsxsok.supabase.co
          SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcnVsZ2thdnR6dW1tYnN4c29rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMTc5OTAsImV4cCI6MjA3NTY5Mzk5MH0.HyY4qR7OLsadOnwITmdn1tAiKyN7AVuNLcuVpLaQfKM
          EOF
          echo "✅ .env file created"

      - name: Install CocoaPods
        script: |
          cd mobile_flutter/finality_app/ios
          pod install

      - name: Remove alpha channel from app icons
        script: |
          ICON_DIR="mobile_flutter/finality_app/ios/Runner/Assets.xcassets/AppIcon.appiconset"
          for icon in "$ICON_DIR"/*.png; do
            # Convert PNG -> JPEG (strips alpha) -> PNG
            sips -s format jpeg "$icon" --out "${icon%.png}.jpg"
            sips -s format png "${icon%.png}.jpg" --out "$icon"
            rm -f "${icon%.png}.jpg"
          done
          echo "✅ Alpha channel removed from all app icons"

      - name: Set up code signing
        script: |
          keychain initialize
          echo "$CM_CERTIFICATE_PRIVATE_KEY" | base64 --decode > /tmp/cert_private_key.pem
          
          # Fetch signing files — distribution certificate + provisioning profile
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create \
            --certificate-key=@file:/tmp/cert_private_key.pem
          keychain add-certificates
          
          # Point use-profiles to the correct xcodeproj in the Flutter subdirectory
          xcode-project use-profiles \
            --project=mobile_flutter/finality_app/ios/Runner.xcodeproj
          
          # Log result
          echo "CM_EXPORT_OPTIONS_PATH=$CM_EXPORT_OPTIONS_PATH"
          echo "CM_PROVISIONING_PROFILE_SPECIFIER=$CM_PROVISIONING_PROFILE_SPECIFIER"

      - name: Build iOS IPA
        script: |
          cd mobile_flutter/finality_app
          set -e
          BUILD_NUMBER=$(date +%s)
          echo "Build number: $BUILD_NUMBER"
          
          # Verify export options exist
          if [ -z "$CM_EXPORT_OPTIONS_PATH" ] || [ ! -f "$CM_EXPORT_OPTIONS_PATH" ]; then
            echo "⚠️ CM_EXPORT_OPTIONS_PATH empty or missing, generating fallback..."
            {
              echo '<?xml version="1.0" encoding="UTF-8"?>'
              echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">'
              echo '<plist version="1.0">'
              echo '<dict>'
              echo '  <key>method</key>'
              echo '  <string>app-store</string>'
              echo '  <key>teamID</key>'
              echo '  <string>P35Y6M742T</string>'
              echo '  <key>signingStyle</key>'
              echo '  <string>manual</string>'
              echo '  <key>uploadBitcode</key>'
              echo '  <false/>'
              echo '  <key>uploadSymbols</key>'
              echo '  <true/>'
              echo '</dict>'
              echo '</plist>'
            } > /tmp/ExportOptions.plist
            export CM_EXPORT_OPTIONS_PATH=/tmp/ExportOptions.plist
          fi
          
          echo "Using export options: $CM_EXPORT_OPTIONS_PATH"
          cat "$CM_EXPORT_OPTIONS_PATH"
          
          flutter build ipa --release \
            --build-name=4.0.0 \
            --build-number=$BUILD_NUMBER \
            --export-options-plist="$CM_EXPORT_OPTIONS_PATH"
          
          echo "== IPA build complete =="
          ls -lh build/ios/ipa/ || echo "WARNING: build/ios/ipa/ not found"
          cp build/ios/ipa/*.ipa $CM_BUILD_DIR/ChecksFleet.ipa
          echo "✅ IPA copied to $CM_BUILD_DIR/ChecksFleet.ipa"

    artifacts:
      - ChecksFleet.ipa
      - mobile_flutter/finality_app/build/ios/ipa/*.ipa
    
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        submit_to_app_store: false
      email:
        recipients:
          - mahdi.convoyages@gmail.com
        notify:
          success: true
          failure: true
        
  android-workflow:
    name: Android Build
    max_build_duration: 60
    instance_type: linux_x2
    environment:
      flutter: 3.38.2
    scripts:
      - name: Get Flutter packages
        script: |
          cd mobile_flutter/finality_app
          flutter pub get
      
      - name: Create .env file
        script: |
          cd mobile_flutter/finality_app
          cat > .env << EOF
          SUPABASE_URL=https://lqrulgkavtzummbsxsok.supabase.co
          SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcnVsZ2thdnR6dW1tYnN4c29rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMTc5OTAsImV4cCI6MjA3NTY5Mzk5MH0.HyY4qR7OLsadOnwITmdn1tAiKyN7AVuNLcuVpLaQfKM
          EOF
      
      - name: Build Android APK
        script: |
          cd mobile_flutter/finality_app
          flutter build apk --release
    
    artifacts:
      - mobile_flutter/finality_app/build/app/outputs/flutter-apk/app-release.apk
